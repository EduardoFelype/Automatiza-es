Sub CopiarDadosDudu()
    Dim wsOrigem As Worksheet
    Dim wbDestino As Workbook
    Dim wsDestino As Worksheet
    Dim ultimaLinha As Long
    Dim i As Long
    Dim colunaOrigemCircuito As Long, colunaOrigemIndisponibilidade As Long
    Dim colunaOrigemIPTelebras As Long, colunaOrigemTotalGeral As Long
    Dim caminhoPastaPrincipal As String
    Dim caminhoPastaSubpasta As String
    Dim caminhoPastaMes As String
    Dim nomeSubpasta As String
    Dim caminhoArquivoDestino As String
    Dim fso As Object
    Dim pastaSubpasta As Object
    Dim pastaOrigem As Object
    Dim nomeMesAnterior As String
    Dim dataAtual As Date
    Dim linhaDestino As Long
    Dim totalIndisponibilidade As Double
    Dim totalIPTelebras As Double
    Dim totalGeral As Double
    ' Solicite o caminho da pasta principal
    With Application.FileDialog(msoFileDialogFolderPicker)
        .Title = "Selecione a pasta principal"
        If .Show = -1 Then
            caminhoPastaPrincipal = .SelectedItems(1)
        Else
            MsgBox "Nenhuma pasta foi selecionada.", vbExclamation
            Exit Sub
        End If
    End With
    ' Inicialize o FileSystemObject
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set pastaOrigem = fso.GetFolder(caminhoPastaPrincipal)
    ' Obtenha o nome do mês anterior
    dataAtual = Date
    nomeMesAnterior = Format(DateAdd("m", -1, dataAtual), "mmmm yyyy")
    ' Defina a planilha de origem
    Set wsOrigem = ThisWorkbook.Sheets("Planilha1")
    ' Identifique as colunas específicas com base no cabeçalho
    colunaOrigemCircuito = Application.Match("No. Circuito", wsOrigem.Rows(1), 0)
    colunaOrigemIndisponibilidade = Application.Match("Indisponibilidade", wsOrigem.Rows(1), 0)
    colunaOrigemIPTelebras = Application.Match("IP TELEBRAS", wsOrigem.Rows(1), 0)
    colunaOrigemTotalGeral = Application.Match("Total Geral", wsOrigem.Rows(1), 0)
    ' Verifique se todas as colunas foram encontradas
    If IsError(colunaOrigemCircuito) Or IsError(colunaOrigemIndisponibilidade) Or IsError(colunaOrigemIPTelebras) Or IsError(colunaOrigemTotalGeral) Then
        MsgBox "Não foram encontradas todas as colunas necessárias na planilha de origem.", vbExclamation
        Exit Sub
    End If
    ' Percorra todas as subpastas dentro da pasta principal
    For Each pastaSubpasta In pastaOrigem.Subfolders
        nomeSubpasta = pastaSubpasta.Name
        ' Crie uma nova subpasta com o nome do mês anterior dentro da subpasta
        caminhoPastaMes = pastaSubpasta.Path & "\" & nomeMesAnterior
        If Not fso.FolderExists(caminhoPastaMes) Then
            fso.CreateFolder caminhoPastaMes
        End If
        ' Defina o caminho completo do arquivo de destino
        caminhoArquivoDestino = caminhoPastaMes & "\" & nomeSubpasta & ".xlsx"
        ' Crie um novo arquivo de destino
        Set wbDestino = Workbooks.Add
        Set wsDestino = wbDestino.Sheets(1)
        ' Adicione o título na planilha de destino
        wsDestino.Cells(1, 1).Value = "PRÉVIA DE FATURAMENTO - " & nomeMesAnterior
        wsDestino.Cells(1, 1).Font.Bold = True
        wsDestino.Cells(1, 1).Font.Size = 14
        wsDestino.Cells(1, 1).HorizontalAlignment = xlCenter
        wsDestino.Cells(1, 1).EntireRow.RowHeight = 30
        ' Defina o cabeçalho na planilha de destino
        wsDestino.Cells(2, 1).Value = "No. Circuito"
        wsDestino.Cells(2, 2).Value = "Indisponibilidade"
        wsDestino.Cells(2, 3).Value = "IP TELEBRAS"
        wsDestino.Cells(2, 4).Value = "Total Geral"
        ' Ajuste o estilo do cabeçalho (opcional)
        With wsDestino.Range("A2:D2")
            .Font.Bold = True
            .HorizontalAlignment = xlCenter
            .VerticalAlignment = xlCenter
            .Interior.Color = RGB(221, 235, 247) ' Cor de fundo azul claro
        End With
        ' Encontre a última linha preenchida na planilha de origem
        ultimaLinha = wsOrigem.Cells(wsOrigem.Rows.Count, 1).End(xlUp).Row
        ' Inicialize a linha de destino
        linhaDestino = 2
        totalIndisponibilidade = 0
        totalIPTelebras = 0
        ' Percorra todas as linhas da planilha de origem
        For i = 2 To ultimaLinha ' Começa na linha 2 para ignorar o cabeçalho
            ' Verifique se o valor na coluna A corresponde ao nome da subpasta
            If Trim(wsOrigem.Cells(i, 1).Value) = Trim(nomeSubpasta) Then
                ' Copie os dados das colunas especificadas para a linha de destino
                wsDestino.Cells(linhaDestino + 1, 1).Value = wsOrigem.Cells(i, colunaOrigemCircuito).Value
                wsDestino.Cells(linhaDestino + 1, 2).Value = wsOrigem.Cells(i, colunaOrigemIndisponibilidade).Value
                wsDestino.Cells(linhaDestino + 1, 3).Value = wsOrigem.Cells(i, colunaOrigemIPTelebras).Value
                wsDestino.Cells(linhaDestino + 1, 4).Value = wsOrigem.Cells(i, colunaOrigemTotalGeral).Value
                ' Acumule os totais
                totalIndisponibilidade = totalIndisponibilidade + wsOrigem.Cells(i, colunaOrigemIndisponibilidade).Value
                totalIPTelebras = totalIPTelebras + wsOrigem.Cells(i, colunaOrigemIPTelebras).Value
                totalGeral = totalIndisponibilidade + totalIPTelebras
                linhaDestino = linhaDestino + 1
            End If
        Next i
        ' Adicione o total geral ao final da planilha
        wsDestino.Cells(linhaDestino + 1, 1).Value = "Total Geral"
        wsDestino.Cells(linhaDestino + 1, 2).Value = totalIndisponibilidade
        wsDestino.Cells(linhaDestino + 1, 3).Value = totalIPTelebras
        wsDestino.Cells(linhaDestino + 1, 4).Value = totalGeral
        ' Formate as células com valores totais como moeda
        wsDestino.Range(wsDestino.Cells(linhaDestino + 1, 2), wsDestino.Cells(linhaDestino + 1, 4)).NumberFormat = "R$ #,##0.00"
        ' Ajuste o estilo da linha de total geral (opcional)
        With wsDestino.Range(wsDestino.Cells(linhaDestino + 1, 1), wsDestino.Cells(linhaDestino + 1, 4))
            .Font.Bold = True
            .HorizontalAlignment = xlCenter
            .Interior.Color = RGB(255, 255, 0) ' Cor de fundo amarela para destacar
        End With
        ' Salve o novo arquivo dentro da subpasta do mês
        wbDestino.SaveAs Filename:=caminhoArquivoDestino, FileFormat:=xlOpenXMLWorkbook
        ' Mensagem de sucesso
        MsgBox "Novo arquivo criado na pasta: " & caminhoArquivoDestino, vbInformation
        ' Feche o arquivo de destino sem salvar alterações adicionais
        wbDestino.Close SaveChanges:=False
    Next pastaSubpasta
End Sub
